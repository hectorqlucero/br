{:entity :propiedades
 :title "Propiedades"
 :table "propiedades"
 :connection :default
 :rights ["U" "A" "S"]
 :mode :parameter-driven

 :menu-category :properties
 :menu-order 1
 :menu-icon "bi bi-house-door"
 :audit? true

 :fields [{:id :id :type :hidden}

          ;; Identificación
          {:id :clave :label "Clave" :type :text :required? true :maxlength 20}
          {:id :titulo :label "Título" :type :text :required? true :maxlength 200}
          {:id :descripcion :label "Descripción" :type :textarea :rows 5}

          {:id :tipo_id
           :label "Tipo de Propiedad"
           :type :fk
           :fk :tipos_propiedad
           :fk-field [:nombre :activo]
           :required? true
           :hidden-in-grid? true}
          {:id :tipo_nombre :label "Tipo de Propiedad" :grid-only? true}

          ;; Ubicación
          {:id :estado_id
           :label "Estado"
           :type :fk
           :fk :estados
           :fk-field [:nombre]
           :required? true
           :hidden-in-grid? true}
          {:id :estado_nombre :label "Estado" :grid-only? true}

          {:id :municipio_id
           :label "Municipio"
           :type :fk
           :fk :municipios
           :fk-field [:nombre]
           :hidden-in-grid? true}
          {:id :municipio_nombre :label "Municipio" :grid-only? true}

          {:id :colonia_id
           :label "Colonia"
           :type :fk
           :fk :colonias
           :fk-field [:nombre :codigo_postal]
           :hidden-in-grid? true}
          {:id :agente_nombre :label "Agente" :grid-only? true}

          {:id :calle :label "Calle" :type :text :maxlength 200}
          {:id :numero_exterior :label "Núm. Exterior" :type :text :maxlength 10}
          {:id :numero_interior :label "Núm. Interior" :type :text :maxlength 10}
          {:id :codigo_postal
           :label "C.P."
           :type :text
           :maxlength 5
           :validation :br.validators.common/codigo-postal-valido?}

          ;; Características
          {:id :terreno_m2 :label "Terreno (m²)" :type :decimal :min 0}
          {:id :construccion_m2 :label "Construcción (m²)" :type :decimal :min 0}
          {:id :recamaras :label "Recámaras" :type :number :min 0}
          {:id :banos_completos :label "Baños Completos" :type :number :min 0}
          {:id :medios_banos :label "Medios Baños" :type :number :min 0}
          {:id :estacionamientos :label "Estacionamientos" :type :number :min 0}
          {:id :niveles :label "Niveles" :type :number :min 1 :value 1}
          {:id :antiguedad_anos :label "Antigüedad (años)" :type :number :min 0}

          ;; Amenidades
          {:id :alberca :label "Alberca" :type :radio :value "F" :options [{:id "albercaF" :value "F" :label "No"}
                                                                           {:id "albercaT" :value "T" :label "Si"}]}
          {:id :jardin :label "Jardín" :type :radio :value "F" :options [{:id "jardinF" :value "F" :label "no"}
                                                                         {:id "jardinT" :value "T" :label "Si"}]}
          {:id :roof_garden :label "Roof Garden" :type :radio :value "F" :options [{:id "roof_gardenF" :value "F" :label "No"}
                                                                                   {:id "roof_gardenT" :value "T" :label "Si"}]}
          {:id :terraza :label "Terraza" :type :radio :value "F" :options [{:id "terrazaF" :value "F" :label "No"}
                                                                           {:id "terrazaT" :value "T" :label "Si"}]}
          {:id :gym :label "Gimnasio" :type :radio :value "F" :options [{:id "gymF" :value "F" :label "No"}
                                                                        {:id "gymT" :value "T" :label "Si"}]}
          {:id :seguridad_24h :label "Seguridad 24h" :type :radio :value "F" :options [{:id "s24F" :value "F" :label "No"}
                                                                                       {:id "s24T" :value "T" :label "Si"}]}

          ;; Comercial
          {:id :operacion
           :label "Operación"
           :type :select
           :required true
           :value "Venta"
           :options [{:value "Venta" :label "Venta"}
                     {:value "Renta" :label "Renta"}
                     {:value "Ambos" :label "Venta y Renta"}]}

          {:id :precio_venta
           :label "Precio de Venta"
           :type :decimal
           :min 0
           :validation :br.validators.common/precio-razonable?}
          {:id :precio_renta :label "Precio de Renta Mensual" :type :decimal :min 0}
          {:id :moneda :label "Moneda" :type :select :value "MXN"
           :options [{:value "MXN" :label "MXN - Peso Mexicano"}
                     {:value "USD" :label "USD - Dólar"}]}

          {:id :status
           :label "Estatus"
           :type :select
           :value "Disponible"
           :options [{:value "Disponible" :label "Disponible"}
                     {:value "Reservada" :label "Reservada"}
                     {:value "Vendida" :label "Vendida"}
                     {:value "Rentada" :label "Rentada"}]}

          {:id :agente_id
           :label "Agente Responsable"
           :type :fk
           :fk :agentes
           :fk-field [:nombre :apellido_paterno :apellido_materno]
           :required? true
           :hidden-in-grid? true}

          {:id :cliente_propietario_id
           :label "Propietario"
           :type :fk
           :fk :clientes
           :fk-field [:nombre :apellido_paterno :apellido_materno]}

          {:id :destacada :label "Propiedad Destacada" :type :checkbox :value "F"}
          {:id :activo :label "Activo" :type :radio :value "T" :options [{:id "activoT" :value "T" :label "Activo"}
                                                                         {:id "activoF" :value "F" :label "Inactivo"}]}

          ;; Campos de solo lectura
          {:id :visitas :label "Visitas" :type :number :hidden-in-form? true}
          {:id :fecha_registro :label "Fecha Registro" :type :date :hidden-in-form? true}

          ;; Audit columns
          {:id :created_by :label "Created By" :type :hidden}
          {:id :created_at :label "Created At" :type :hidden}
          {:id :modified_by :label "Modified By" :type :hidden}
          {:id :modified_at :label "Modified At" :type :hidden}]

 :queries {:list "SELECT p.*, 
                 tp.nombre as tipo_nombre,
                 e.nombre as estado_nombre,
                 m.nombre as municipio_nombre,
                 concat(a.nombre,' ',a.apellido_paterno) as agente_nombre
          FROM propiedades p
          LEFT JOIN tipos_propiedad tp ON p.tipo_id = tp.id
          LEFT JOIN estados e ON p.estado_id = e.id
          LEFT JOIN municipios m ON p.municipio_id = m.id
          LEFT JOIN agentes a ON p.agente_id = a.id
          WHERE p.activo = 'T'
          ORDER BY p.fecha_registro DESC"

           :get "SELECT p.*,
                tp.nombre as tipo_nombre,
                e.nombre as estado_nombre,
                m.nombre as municipio_nombre,
                concat(a.nombre,' ',a.apellido_paterno) as agente_nombre
                FROM propiedades p
                LEFT JOIN tipos_propiedad tp ON p.tipo_id = tp.id
                LEFT JOIN estados e on p.estado_id = e.id
                LEFT JOIN municipios m ON p.municipio_id = m.id
                LEFT JOIN agentes a ON p.agente_id = a.id
                WHERE p.id = ?"}

 :actions {:new true :edit true :delete false}

 :hooks {:before-load :br.hooks.propiedades/cargar-opciones
         :before-save :br.hooks.propiedades/validar-propiedad
         :after-save :br.hooks.propiedades/generar-clave
         :before-delete :br.hooks.propiedades/verificar-transacciones}

 :subgrids [{:entity :fotos_propiedad
             :foreign-key :propiedad_id
             :title "Fotos"
             :icon "bi bi-images"}

            {:entity :avaluos
             :foreign-key :propiedad_id
             :title "Avalúos"
             :icon "bi bi-graph-up"}

            {:entity :citas
             :foreign-key :propiedad_id
             :title "Citas/Visitas"
             :icon "bi bi-calendar-event"}]}
